name: DKIM Audit (Dev)

on:
  push:
    branches:
      - dkim-audit

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ca-central-1

jobs:
  dkim-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@d632683dd7b4114ad314bca15554477dd762a938 # v4.2.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.DEV_ACCOUNT_ID }}:role/dkim-audit
          role-session-name: dkimAudit
          aws-region: ${{ env.AWS_REGION }}

      - name: Run DKIM audit
        id: audit
        run: bash scripts/dkim_audit/check_dkim.sh dev

      - name: Report results
        if: always()
        run: |
          echo "## DKIM Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment || matrix.env }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ steps.audit.outcome }} == 'success' ]; then
            echo "✅ All DKIM records are healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ DKIM issues detected - check workflow logs for details" >> $GITHUB_STEP_SUMMARY
          fi

  on-failure:
    runs-on: ubuntu-latest
    needs: dkim-audit
    if: always() && needs.dkim-audit.result == 'failure'
    steps:
      - name: Checkout
        uses: actions/checkout@d632683dd7b4114ad314bca15554477dd762a938 # v4.2.0

      - name: Download step summary
        run: |
          # Get the summary content if available
          if [ -f "$GITHUB_STEP_SUMMARY" ]; then
            cp "$GITHUB_STEP_SUMMARY" /tmp/summary.txt
          else
            echo "No summary available" > /tmp/summary.txt
          fi

      - name: Notify Slack
        run: |
          set -euo pipefail
          
          RUN_LINK='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          
          # Read summary and format for Slack
          SUMMARY=$(cat /tmp/summary.txt 2>/dev/null || echo "Check logs for details")
          
          # Build the Slack message using jq for proper JSON escaping
          MESSAGE=$(jq -nc \
            --arg link "$RUN_LINK" \
            --arg summary "$SUMMARY" \
            '{
              blocks: [
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: (":red_circle: *DKIM audit failed (DEV)*\n\n" + $summary + "\n\n<" + $link + "|View workflow logs>")
                  }
                }
              ]
            }')
          
          curl -s -X POST \
            -H 'Content-type: application/json' \
            --data "$MESSAGE" \
            ${{ secrets.NOTIFY_DEV_SLACK_WEBHOOK }}
