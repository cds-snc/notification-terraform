name: "Terragrunt plan STAGING"

env:
  ENVIRONMENT: staging
  ACCOUNT_ID: ${{ secrets.STAGING_AWS_ACCOUNT_ID }}
  AWS_REGION: ca-central-1
  OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN_STAGING }}
  TERRAFORM_VERSION: 1.11.4
  TERRAGRUNT_VERSION: 0.77.22
  WORKFLOW: true

on:
  workflow_dispatch:
  pull_request:
    paths:
      - ".env"
      - "aws/**"
      - "env/$ENVIRONMENT/**"
      - "env/terragrunt.hcl"
      - "env/*.tfvars"
      - ".github/workflows/terragrunt_plan_$ENVIRONMENT.yml"

permissions:
  id-token: write # This is required for requesting the OIDC JWT
  contents: write # This is required for actions/checkout
  pull-requests: write

jobs:
  terragrunt-run-all-plan:
    runs-on: ubuntu-latest
    outputs:
      exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout
        uses: actions/checkout@d632683dd7b4114ad314bca15554477dd762a938 # v4.2.0
      
      - uses: ./.github/actions/setup-terraform
        with:
          role_to_assume: arn:aws:iam::${{env.ACCOUNT_ID}}:role/notification-terraform-plan
          role_session_name: NotifyTerraformPlan
      
      - name: Install 1Pass CLI and Download TFVars
        run: |
          curl -o 1pass.deb https://downloads.1password.com/linux/debian/amd64/stable/1password-cli-amd64-latest.deb
          sudo dpkg -i 1pass.deb
          sudo mkdir -p aws && cd aws
          op read op://4eyyuwddp6w4vxlabrr2i2duxm/"TERRAFORM_SECRETS_${{env.ENVIRONMENT}}"/notesPlain > ${{env.ENVIRONMENT}}.tfvars
      
      - name: Terragrunt Run All Plan
        id: plan
        working-directory: env/${{env.ENVIRONMENT}}
        run: |
          set +e  # Don't exit on error so we can capture output
          
          # Run terragrunt plan on all modules except quicksight and aws-auth
          terragrunt run-all plan \
            --terragrunt-exclude-dir quicksight \
            --terragrunt-exclude-dir aws-auth \
            --terragrunt-non-interactive \
            --terragrunt-parallelism 20 2>&1 | tee plan_output.txt
          
          PLAN_EXIT_CODE=${PIPESTATUS[0]}
          
          # Debug: Check if file exists and show size
          echo "Plan output file size: $(wc -c < plan_output.txt) bytes"
          echo "Plan output file lines: $(wc -l < plan_output.txt) lines"
          
          # Set exit code as output for the comment step
          echo "exitcode=$PLAN_EXIT_CODE" >> $GITHUB_OUTPUT
          
          exit $PLAN_EXIT_CODE
          
      - name: Upload plan output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: plan-output
          path: env/${{env.ENVIRONMENT}}/plan_output.txt
          retention-days: 1

  comment-pr:
    needs: terragrunt-run-all-plan
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Download plan output
        uses: actions/download-artifact@v4
        with:
          name: plan-output
          path: ./
          
      - name: Parse and Comment Plan Results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read the plan output from artifact
            let planOutput = '';
            let exitCode = '${{ needs.terragrunt-run-all-plan.outputs.exitcode }}';
            
            try {
              planOutput = fs.readFileSync('plan_output.txt', 'utf8');
              console.log(`Read plan output: ${planOutput.length} characters`);
            } catch (error) {
              console.log('Could not read plan output file:', error.message);
              planOutput = 'Error: Could not read plan output';
            }
            
            // Create summary comment first
            const summaryOutput = `#### üèóÔ∏è Terragrunt Plan Summary for ${{env.ENVIRONMENT}}
            
            *Plan exit code: ${exitCode}*
            *Action: \`${{ github.event_name }}\`*
            *Total output size: ${planOutput.length} characters*
            
            üìã Individual module plans are posted as separate comments below.`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summaryOutput
            });
            
            // Parse output by module - look for terragrunt module execution patterns
            const lines = planOutput.split('\n');
            let currentModule = '';
            let moduleOutput = '';
            let moduleCount = 0;
            const maxCommentSize = 60000;
            
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i];
              
              // Look for terragrunt module start patterns
              if (line.includes('env/staging/') && (line.includes('Executing') || line.includes('Running'))) {
                // If we have a previous module, post it
                if (currentModule && moduleOutput.trim()) {
                  await postModuleComment(currentModule, moduleOutput, maxCommentSize);
                  moduleCount++;
                  await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Extract module name
                const moduleMatch = line.match(/env\/staging\/([^\/\s]+)/);
                if (moduleMatch) {
                  currentModule = moduleMatch[1];
                  moduleOutput = line + '\n';
                }
              } else if (currentModule) {
                moduleOutput += line + '\n';
              }
            }
            
            // Post the last module if exists
            if (currentModule && moduleOutput.trim()) {
              await postModuleComment(currentModule, moduleOutput, maxCommentSize);
              moduleCount++;
            }
            
            console.log(`Created ${moduleCount} module comments`);
            
            // Helper function to post module comments
            async function postModuleComment(moduleName, output, maxSize) {
              let moduleOutput = output;
              if (moduleOutput.length > maxSize) {
                moduleOutput = moduleOutput.substring(0, maxSize - 500) + '\n\n... (output truncated due to size)';
              }
              
              const moduleComment = `#### üì¶ Module: \`${moduleName}\`
              
              \`\`\`
              ${moduleOutput.trim()}
              \`\`\``;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: moduleComment
              });
            }