name: DKIM Audit

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ca-central-1

jobs:
  dkim-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@d632683dd7b4114ad314bca15554477dd762a938 # v4.2.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.PRODUCTION_AWS_ACCOUNT_ID }}:role/dkim-audit-main
          role-session-name: dkimAudit
          aws-region: ${{ env.AWS_REGION }}

      - name: Run DKIM audit
        id: audit
        run: |
          # Capture output to both stdout and a file
          bash scripts/dkim_audit/check_dkim.sh production 2>&1 | tee /tmp/audit_output.txt
          # Preserve exit code
          exit ${PIPESTATUS[0]}

      - name: Save audit output
        if: always()
        run: |
          # Save the raw output for Slack notification
          cp /tmp/audit_output.txt audit_output.txt || echo "No audit output" > audit_output.txt

      - name: Upload audit output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-output
          path: audit_output.txt
          retention-days: 7

      - name: Report results
        if: always()
        run: |
          echo "## DKIM Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ steps.audit.outcome }} == 'success' ]; then
            echo "✅ All DKIM records are healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ DKIM issues detected - check workflow logs for details" >> $GITHUB_STEP_SUMMARY
          fi

  on-failure:
    runs-on: ubuntu-latest
    needs: dkim-audit
    if: always() && needs.dkim-audit.result == 'failure'
    steps:
      - name: Download audit output
        uses: actions/download-artifact@v4
        with:
          name: audit-output

      - name: Notify Slack
        run: |
          set -euo pipefail
          
          RUN_LINK='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          
          # Read audit output
          AUDIT_OUTPUT=$(cat audit_output.txt 2>/dev/null || echo "Check logs for details")
          
          # Build the Slack message using jq for proper JSON escaping
          MESSAGE=$(jq -nc \
            --arg link "$RUN_LINK" \
            --arg output "$AUDIT_OUTPUT" \
            '{
              blocks: [
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: (":red_circle: *DKIM audit failed*\n\n```\n" + $output + "\n```\n\n<" + $link + "|View workflow logs>\n\n<https://docs.google.com/document/d/16LLelZ7WEKrnbocrl0Az74JqkCv5DBZ9QILRBUFJQt8/edit?tab=t.0|Tips and Tricks>\n<https://docs.google.com/document/d/1gQSBJ-kr4Pi0m121F66a5no4Sb6PPsObs7nfEAuzNcg/edit?pli=1&tab=t.db84hyceg8xe#heading=h.yve4tikg5m0l|Incident Management for Provincial Partners>")
                  }
                }
              ]
            }')
          
          curl -s -X POST \
            -H 'Content-type: application/json' \
            --data "$MESSAGE" \
            ${{ secrets.NOTIFICATION_OPS_SLACK_WEBHOOK_CRITICAL_TOPIC_PRODUCTION }}
